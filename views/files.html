{% include 'includes/header.html' %}
{% include 'includes/menu.html' %}
<div class="container">
    <div class="starter-template">
        <h1>{{h1}}</h1>
        <input type="file" id="fileElem" multiple style="display:none" onchange="handleFiles(this.files)">
        <div id="fileList">
            <p>No files selected!</p>
        </div>
        <button id="upload-button" type="submit" class="btn btn-default">Select some files</button>
        <h2>Files</h2>
        <table id="files" class="table .table-condensed .table-hover">

        </table>
    </div>
    {% include 'includes/footer_scripts.html' %}
    <script type="text/javascript">
        $(document).ready(function(){
            loadFiles();
        });

        function loadFiles() {
            $.ajax({
                url: "api/files/get",
                success: function(result){
                    if(result.result) {
                        $("#files").children().remove();
                        for(var file in result.data) {
                            $("#files").append("<tr>" +
                            "<td><a href='files/download/" + result.data[file].id +"/"+
                            result.data[file].name + "'>"+result.data[file].name+"</a></td>" +
                            "<td class='ar'>"+ result.data[file].size+"</td>" +
                            "<td class='ar'>"+ result.data[file].mimetype+"</td>" +
                            "<td class='ar'>"+ result.data[file].created+"</td>" +
                            "</tr>");
                        }
                    } else {
                        // TODO: error message/action
                    }
                },
                error: function(result) {
                    console.log(result);
                }
            });
        }

        var uploadButton = document.getElementById("upload-button");
        var fileElem = document.getElementById("fileElem");
        uploadButton.addEventListener("click", function(event){
            fileElem.click();
        });

        function handleFiles(fileSelect) {

            // Update button text.
            uploadButton.innerHTML = 'Uploading...';

            if(fileSelect.files && fileSelect.files.length > 0) {
                var files = fileSelect.files;
                var formData = new FormData();

                // Loop through each of the selected files.
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    // Add the file to the request.
                    formData.append('filesselect[]', file, file.name);
                }


                // Set up the request.
                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'api/files/add', true);

                // Set up a handler for when the request finishes.
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        // File(s) uploaded.
                        uploadButton.innerHTML = 'Upload';
                        loadFiles();
                        delete fileSelect.files;
                    } else {
                        console.log(xhr);
                        alert('An error occurred!');
                    }
                };

                // Send the Data.
                xhr.send(formData);
            }
        }
    </script>
</div>
{% include 'includes/footer.html' %}